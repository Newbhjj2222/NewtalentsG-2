 <!DOCTYPE html>
<html lang="rw">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="story.css" type="text/css" media="all" />
  <title>NewtalentsG Stories Uploader Tool</title>
</head>

<body>
  <div class="intro">
    <h2>NewtalentsG Stories Uploader Tool</h2>
    <p>
      Iyi tool, iragufasha gutangaza episodes 25 z'inkuru imwe zose icyarimwe. Ni tool yihuta kandi yoroshye gukoresha. Ugize ikibazo,
      twandikire Whatsapp 0722319367.
    </p>
  </div>
  
  <div class="stories">
    <h2>Copy and paste your story, each part and its details in their place.</h2>
    <form id="storyForm">
      <div id="stories-container">
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 1" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 2" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 3" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 4" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 5" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 6" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 7" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 8" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 9" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 10" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 11" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 12" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 13" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 14" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 15" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 16" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 17" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 18" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 19" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 20" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 21" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 22" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 23" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 24" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
        <div class="story">
          <input type="text" name="head[]" placeholder="Umutwe w’inkuru 25" />
          <div class="episode" contenteditable="true" data-name="description[]"></div>
        </div>
      </div>
       <label>Hitamo ifoto y’inkuru:</label>
      
     <input type="file" name="image" required/>
      
      <label>Hitamo amoko y’inkuru:</label>
  <select name="categories[]" class="categories" multiple required>
  <option value="Action">Ibikorwa (Action)</option>
  <option value="Urwenya">Urwenya(Comedy)</option>
  <option value="Drama">Drama</option>
  <option value="Urukundo">Urukundo (Romance)</option>
  <option value="Ubwoba">Ubwoba (Horror)</option>
  <option value="Ubumenyi bw'ikoranabuhanga">Ubumenyi bw'ikoranabuhanga (Science Fiction)</option>
  <option value="Ibyiyumviro">Ibyiyumviro / Fantasy</option>
  <option value="Ubwoba bukomeye">Ubwoba bukomeye (Thriller)</option>
  <option value="Ibitangaza">Ibitangaza / Mystery</option>
  <option value="Dokumentari">Dokumentari (Documentary)</option>
  <option value="Abana">Abana (Children / Kids)</option>
  <option value="Inyongera y'ingendo">Inyongera y'ingendo (Adventure)</option>
  <option value="Amateka">Amateka (Historical)</option>
  <option value="Ubumenyi">Ubumenyi / Educational</option>
  <option value="Amateka y'umuntu">Amateka y'umuntu (Biographical)</option>
  <option value="Ibyaha">Ibyaha (Crime)</option>
  <option value="Politiki">Politiki (Political)</option>
  <option value="Abanyamerika b'uburengerazuba">Abanyamerika b'uburengerazuba / Western</option>
  <option value="Iby'umwuka">Iby'umwuka / Supernatural</option>
  <option value="Imikino">Imikino / Sports</option>
  <option value="Umuziki">Umuziki / Musical</option>
  <option value="Urukundo rw'umubiri">Urukundo rw'umubiri / Erotic</option>
  <option value="Gusesengura / Icyiyumviro">Gusesengura / Satire</option>
  <option value="Imitekerereze">Imitekerereze / Psychological</option>
  <option value="Igendo">Ingendo / Travel</option>
</select>
  <div class="tags-preview"></div>
      <label>Hitamo  folder:</label>
       <select id="folderSelector" required>
        <option value="">-- Choose a folder --</option>
        <!-- Options could be added dynamically if needed -->
      </select>
      
      
      
      
      <button type="submit">Ohereza Inkuru</button>
    </form>
    
    
     
  </div>
  
  
   <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where, orderBy, initializeFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAvwNyhKiKFyI-r6MDDk7BH3iq7P61z594",
  authDomain: "newtalents-a7c29.firebaseapp.com",
  databaseURL: "https://newtalents-a7c29-default-rtdb.firebaseio.com",
  projectId: "newtalents-a7c29",
  storageBucket: "newtalents-a7c29.appspot.com",
  messagingSenderId: "507408992610",
  appId: "1:507408992610:web:05ce220a4cb4922de9843b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);
const db = initializeFirestore(app, {
  experimentalForceLongPolling: true,
  useFetchStreams: false
});
        
        
        // Gufata amakuru y'amafolder
        async function fetchFolders(db) {
          const folderSelector = document.getElementById("folderSelector");
          
          try {
            folderSelector.innerHTML = ""; // Gusiba ibisanzwe
            const username = localStorage.getItem("username");
            if (!username) {
              throw new Error("Username not found in localStorage.");
            }
            
            const querySnapshot = await getDocs(collection(db, "folders"));
            let foldersFound = false;
            
            // Kongeramo amafolder asanzwe
            querySnapshot.forEach((doc) => {
              const folderData = doc.data();
              if (folderData.author === username) {
                const option = document.createElement("option");
                option.value = doc.id;
                option.textContent = folderData.title;
                folderSelector.appendChild(option);
                foldersFound = true;
              }
            });
            
            // Gushyiramo uburyo bwo gukora folder nshya
            setupFolderCreation(folderSelector, username, db);
            
          } catch (error) {
            console.error("Error fetching folders: ", error);
          }
        }
        
        // Gukora folder nshya
        async function createNewFolder(newFolderName, username) {
          try {
            // Kwemeza ko db ikora
            if (!db) {
              console.error("Firestore DB is not initialized.");
              return false;
            }
            
            // Kora document nshya muri Firestore
            await addDoc(collection(db, "folders"), {
              title: newFolderName,
              author: username,
              createdAt: new Date().toISOString()
            });
            alert("Folder created successfully!");
            return true;
          } catch (createError) {
            // Gufata amakuru y'ikosa yose, harimo message, code, na stack trace
            console.error("Error creating new folder: ", createError.message);
            console.error("Error code: ", createError.code);
            console.error("Stack trace: ", createError.stack);
            alert("Failed to create folder. Please try again.");
            return false;
          }
        }
        // Setup ya folder creation
        function setupFolderCreation(folderSelector, username, db) {
          const createNewOption = document.createElement("option");
          createNewOption.value = "create-new";
          createNewOption.textContent = "Create New Folder";
          
          // Kureba niba "Create New Folder" itarabanje gushyirwamo
          if (!Array.from(folderSelector.options).some((opt) => opt.value === "create-new")) {
            folderSelector.appendChild(createNewOption);
          }
          
          // Guhamagara igihe user ahisemo "Create New Folder"
          folderSelector.addEventListener("change", async (event) => {
            if (event.target.value === "create-new") {
              const newFolderName = prompt("Enter the name of your story for the new folder:");
              if (newFolderName) {
                const created = await createNewFolder(newFolderName, username, db);
                if (created) {
                  // Hamagara fetchFolders() kugira ngo ihindure urutonde rw'amafolder
                  fetchFolders(db);
                }
              }
            }
          });
        }
        
        fetchFolders(db);
        
        
        
        document.getElementById("storyForm").addEventListener("submit", async function(event) {
  event.preventDefault();
  
  const author = localStorage.getItem("username") || "unknown author";
  const folderId = document.getElementById("folderSelector")?.value;
  if (!folderId) {
    alert("Hitamo folder mbere yo kohereza.");
    return;
  }
  
  const fileInput = document.querySelector('input[name="image"]');
  const file = fileInput?.files?.[0];
  
  let uploadedImageUrl = "";
  
  if (file) {
    try {
      const API_KEY = "d3b627c6d75013b8aaf2aac6de73dcb5";
      const formData = new FormData();
      formData.append("image", file);
      
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
        method: "POST",
        body: formData
      });
      
      const data = await response.json();
      if (!data.success) throw new Error(data.error?.message || "Image upload failed");
      uploadedImageUrl = data.data.url;
    } catch (error) {
      alert("Ntibyagenze neza kohereza ifoto: " + (error.message || error));
      return;
    }
  }
  
  // Fata categories zo muri select imwe (uri guhitamo)
  const categoriesSelect = document.querySelector("select.categories");
  const sharedCategories = Array.from(categoriesSelect.selectedOptions).map(opt => opt.value);
  
  const stories = document.querySelectorAll("#stories-container .story");
  const promises = [];
  
  stories.forEach((storyDiv) => {
    const titleInput = storyDiv.querySelector('input[name="head[]"]');
    const episodeDiv = storyDiv.querySelector('.episode');
    
    const title = titleInput?.value?.trim();
    const content = episodeDiv?.innerHTML?.trim();
    
    if (title && content) {
      const postRef = doc(collection(db, "posts"));
      const storyData = {
        head: title,
        story: content,
        categories: sharedCategories, // categories zimwe kuri buri nkuru
        imageUrl: uploadedImageUrl || "",
        folderId: folderId,
        author: author,
        createdAt: new Date().toISOString()
      };
      promises.push(setDoc(postRef, storyData));
    }
  });
  
  try {
    await Promise.all(promises);
    alert("Inkuru zose zoherejwe neza!");
    window.location.reload();
  } catch (error) {
    alert("Hari ikibazo cyo kubika inkuru: " + (error.message || error));
    console.error(error);
  }
});
        
// Tags preview kuri buri story
document.querySelectorAll('.categories').forEach(select => {
  const previewDiv = select.nextElementSibling;
  select.addEventListener('change', () => {
    previewDiv.innerHTML = "";
    Array.from(select.selectedOptions).forEach(opt => {
      const span = document.createElement('span');
      span.classList.add('tag');
      span.textContent = opt.value;
      previewDiv.appendChild(span);
    });
  });
});
        
        </script>
  
  
  
</body>
</html>
